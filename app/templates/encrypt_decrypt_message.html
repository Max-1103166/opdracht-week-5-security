{% extends "index.html" %}
{% block body_content %}
<div class="col-12 container">
    <!-- versturen -->
    <div class="col-12">
        <form id="sendForm" class="send_form col-6">

            <div class="user_select">
                <label for="users">Kies een user (afzender):</label>
                <select id="users" name="user_id">
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="user_select">
                <label for="receiver">Kies een ontvanger:</label>
                <select id="receiver" name="receiver_id">
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
                </select>
            </div>

            <div class="message_input">
                <label for="message">Bericht:</label>
                <input type="text" name="message" placeholder="Type je bericht" id="message" required>
            </div>

            <button type="submit" id="submit_send_button">Verstuur</button>
        </form>


        <div class="response col-6" >
            <p>Encrypted bericht:</p>
            <div class="message" style="font-size:10px; word-wrap: break-word;"></div>
        </div>
    </div>

    <!-- ophalen van bericht -->
    <div class="col-12">
        <form id="retrieveForm" class="send_form col-6">
            <div class="user_select">
                <label for="current_user">Kies een ontvanger:</label>
                <select id="current_user" name="receiver_id">
                {% for user in users %}
                <option value="{{ user.id }}">{{ user.name }}</option>
                {% endfor %}
                </select>
            </div>
            <p>Encrypted bericht:</p>
            <div class="response" >
                <div class="message" style="font-size:10px; word-wrap: break-word;"></div>
            </div>
            <button type="submit" id="retrieve_button">decrypt</button>
        </form>
        <div class="col-6">
            <p>Decrypted bericht:</p>
            <div id="decrypted_message">

            </div>
        </div>
    </div>
</div>
<script>
<!--    javascript voor ophalen van en versturen van bericht-->

document.getElementById('sendForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const responseEl = document.getElementsByClassName('response');
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        const res = await fetch('/api/send_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
        });
        const result = await res.json();
        [...responseEl].forEach(e => {
            console.log(e.querySelector('.message'))
            e.querySelector('.message').textContent = result.messages['message'];
        });
    } catch (err) {
        responseEl.textContent = "Fout bij verzenden van bericht.";
    }
});

document.getElementById('retrieveForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const responseEl = document.getElementById('decrypted_message');
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    try {
        const res = await fetch('/api/retrieve_message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
        });
        const result = await res.json();
        console.log(result)
        responseEl.textContent = result.messages['message'];
    } catch (err) {
        responseEl.textContent = "Fout bij ophalen van bericht.";
    }
});
</script>
{% endblock %}